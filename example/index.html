<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head>
  <style>
    .dropBox {
      background-color: red;
      color: white;
      padding: 4em;
    }
  </style>
</head>

<body>
  <div class='dropBox' id="drop">Drop On Me</div>
  <button id="btn">Press Me</button>
</body>

<script type="module">
  import init, { greet, read_bytes } from './pkg/hello_wasm.js'

  async function initialization() {
    await init();

    const drop = document.querySelector('#drop');
    console.log('drop', drop);
    drop.addEventListener("dragover", (ev) => {
      // prevent default to allow drop
      ev.preventDefault();
    });
    drop.addEventListener('drop', (ev) => {
      ev.preventDefault();

      console.log('drop', ev);
      console.log(ev.dataTransfer);

      const files = ev.dataTransfer?.files ?? [];
      for (const item of files) {
        readFileAsBytes(item);
      }
    });

    document.querySelector('#btn').addEventListener('click', () => {
      console.log('click');
      greet('Hey, hey, hey!');
    });
  }

  async function readFileAsBytes(file) {
    console.log(file instanceof File);
    const buf = await file.arrayBuffer();

    console.log(buf);

    const uint8Arr = new Uint8Array(buf);

    console.log(uint8Arr);

    try {
      const result = read_bytes(uint8Arr);
      console.log('result', result, result instanceof Uint8Array);
      makeFileFromBytes(result);
    } catch (e) {
      console.error(e);
    }
  }

  async function makeFileFromBytes(bytesArray) {
    const b64encoded = btoa(String.fromCharCode(...bytesArray));
    console.log('after b64encoded');

    console.log(b64encoded);

    // const file = new File(bytesArray, 'new image');
    // console.log('file', file);

    // const text = await file.text();

    const downloadEl = document.createElement('a');
    downloadEl.setAttribute('href', 'data:image/jpeg;base64,' + encodeURIComponent(b64encoded));
    downloadEl.setAttribute('download', 'new_image.jpg');

    downloadEl.style.display = 'none';
    document.body.appendChild(downloadEl);

    downloadEl.click();

    document.body.removeChild(downloadEl);
  }

  initialization();
</script>

</html>